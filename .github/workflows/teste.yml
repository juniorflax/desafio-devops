name: Testes na Aplicação

on:
  push:
    branches: [main]

jobs:
  configuracao_e_instalacao:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do Código
      uses: actions/checkout@v4.1.2
      
    - name: Configurar Ambiente Python e Instalar Dependências
      uses: ./.github/actions/configure-python-env
      with:
        python-version: '3.10.12'
        requirements-path: ./app/requirements.txt

  testes:
    needs: configuracao_e_instalacao
    runs-on: ubuntu-latest

    steps:
    - name: Iniciar Servidor da Aplicação
      working-directory: app
      run: |
        gunicorn --daemon --bind localhost:8000 api:app
        sleep 5  # Espera alguns segundos para que o servidor inicie
        
    - name: Testar Aplicação
      run: |
        curl -sv localhost:8000/api/comment/new -X POST -H 'Content-Type: application/json' -d '{"email":"alice@example.com","comment":"first post!","content_id":1}'
        curl -sv localhost:8000/api/comment/list/1

  construcao_e_publicacao:
    needs: configuracao_e_instalacao
    runs-on: ubuntu-latest

    steps:
    - name: Build the Docker image
      working-directory: app
      run: docker build . --file Dockerfile --tag ${{ secrets.USER_DOCKERHUB }}/desafio-devops:v0.2

    - name: Login DockerHub
      uses: docker/login-action@v3.1.0
      with:
        username: ${{ secrets.USER_DOCKERHUB }}
        password: ${{ secrets.PASS_DOCKERHUB }}

    - name: Push the Docker image
      working-directory: app
      run: docker push ${{ secrets.USER_DOCKERHUB }}/desafio-devops:v0.2